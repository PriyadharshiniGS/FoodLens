<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodLens - Track</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Pacifico&display=swap" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="relative">
        <img alt="Background image of various healthy foods like fruits and vegetables" class="absolute inset-0 w-full h-full object-cover opacity-50" height="1080" src="https://storage.googleapis.com/a1aa/image/TxcHG83fo-JUYBIxp77kqqVEStGN3Y9n0Z6ufVIpxWw.jpg" width="1920"/>
        
        <div class="relative container mx-auto p-4 min-h-screen flex flex-col justify-between">
            <!-- Main Content -->
            <main class="mt-8 flex-grow">
                <!-- Header -->
                <header class="flex justify-between items-center py-4">
                    <div>
                        <h1 class="text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-black to-black" style="font-family: 'Pacifico', cursive;">
                            FoodLens
                        </h1>
                        <p class="text-lg text-gray-700">
                            Your Pocket Nutrition Expert!
                        </p>
                    </div>
                    
                    <!-- Hamburger Menu -->
                    <div class="relative">
                        <button class="text-black focus:outline-none" id="menu-button">
                            <i class="fas fa-bars fa-2x"></i>
                        </button>

                        <!-- Navigation Menu -->
                        <nav class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg hidden" id="menu">
                            <ul class="py-2">
                                <li><a href="index.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-200 menu-link">üè† Home</a></li>

                                <li><a href="goals.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-200 menu-link">üéØ Goals</a></li>
                                <li><a href="track.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-200 menu-link">üìä Track</a></li>
                                <li><a href="Nearby.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-200 menu-link">üìç Nearby</a></li>
                                <li><a href="profile.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-200 menu-link">üë§ Profile</a></li>
                            </ul>
                        </nav>
                    </div>
                </header>

                <!-- Track Section -->
                <section class="bg-white p-6 rounded-lg shadow-md" id="track">
                    <h2 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-black to-black mb-4">
                        Track Your Nutrition
                    </h2>
                    <div class="flex flex-col items-center">
                        <div class="w-full mb-4">
                            <label class="block text-gray-700 mb-2" for="nutrition-name">
                                Nutrition Name
                            </label>
                            <input class="w-full px-3 py-2 border rounded-lg" id="nutrition-name" name="nutrition-name" type="text"/>
                        </div>
                        <div class="w-full mb-4">
                            <label class="block text-gray-700 mb-2" for="calories">
                                Calories (kcal)
                            </label>
                            <input class="w-full px-3 py-2 border rounded-lg" id="calories" name="calories" type="number"/>
                        </div>
                        <div class="w-full mb-4">
                            <label class="block text-gray-700 mb-2" for="date">
                                Date
                            </label>
                            <input class="w-full px-3 py-2 border rounded-lg" id="date" name="date" type="date"/>
                        </div>
                        <button class="bg-gradient-to-r from-black to-black text-white px-4 py-2 rounded-lg hover:from-gray-800 hover:to-gray-800" onclick="addNutrition()">
                            Add Nutrition
                        </button>
                        <div class="mt-8 w-full">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">
                                Nutrition History
                            </h3>
                            <ul id="nutrition-history" class="list-disc pl-5 text-gray-700">
                                <!-- Nutrition history items will be dynamically inserted here -->
                            </ul>
                        </div>
                    </div>
                </section>
            </main>

            <footer class="bg-green-600 text-white p-4 text-center shadow-lg">
                <p>¬© 2023 FoodLens. All rights reserved.</p>
            </footer>
        </div>
    </div>

    <script>
        const menuButton = document.getElementById('menu-button');
        const menu = document.getElementById('menu');
        const menuLinks = document.querySelectorAll('.menu-link');

        // Toggle menu on hamburger icon click
        menuButton.addEventListener('click', function(event) {
            menu.classList.toggle('hidden'); 
            event.stopPropagation(); // Prevent click from propagating
        });

        // Close menu when clicking a menu item
        menuLinks.forEach(link => {
            link.addEventListener('click', function() {
                menu.classList.add('hidden');
            });
        });

        // Close menu when clicking outside
        document.addEventListener("click", function(event) {
            if (!menu.contains(event.target) && !menuButton.contains(event.target)) {
                menu.classList.add("hidden");
            }
        });

        async function addNutrition() {
            const nutritionName = document.getElementById('nutrition-name').value;
            const calories = document.getElementById('calories').value;
            const date = document.getElementById('date').value;
            const token = localStorage.getItem('token');

            if (!token) {
                alert('Please login to track nutrition.');
                window.location.href = 'loginsignup.html';
                return;
            }

            if (nutritionName && calories && date) {
                try {
                    const response = await fetch('http://localhost:3000/api/nutrition', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            foodName: nutritionName,
                            calories: calories,
                            date: date
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Failed to save nutrition data: ${errorData.message || response.statusText}`);
                    }

                    
                    // Clear the input fields
                    document.getElementById('nutrition-name').value = '';
                    document.getElementById('calories').value = '';
                    document.getElementById('date').value = '';
                    
                    // Refresh nutrition history
                    loadNutritionHistory();
                    alert('Nutrition data saved successfully!');
                } catch (error) {
                    console.error('Error details:', error.message);
                    console.error('Full error:', error);
                    alert(`Failed to save nutrition data: ${error.message}. Please try again.`);

                }
            } else {
                alert('Please fill in all fields.');
            }
        }

        async function loadNutritionHistory() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No token found in localStorage');
                alert('Please login to view nutrition history.');
                window.location.href = 'loginsignup.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/nutrition', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error details:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorData
                    });
                    throw new Error(`Failed to load nutrition history: ${errorData.message || response.statusText}`);
                }
                
                const nutritionData = await response.json();
                console.log('Received nutrition data:', nutritionData);
                
                const nutritionHistory = document.getElementById('nutrition-history');
                nutritionHistory.innerHTML = '';

                if (nutritionData.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.textContent = 'No nutrition history found. Start tracking your meals!';
                    nutritionHistory.appendChild(emptyMessage);
                } else {
                    nutritionData.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${new Date(item.date).toLocaleDateString()}: ${item.foodName} - ${item.calories} kcal`;
                        nutritionHistory.appendChild(listItem);
                    });
                }
            } catch (error) {
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                alert(`Failed to load nutrition history: ${error.message}`);
            }
        }


        // Load nutrition history when page loads
        document.addEventListener('DOMContentLoaded', loadNutritionHistory);

    </script>
</body>
</html>
